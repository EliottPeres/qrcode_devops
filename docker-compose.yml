services:
  # --- Reverse Proxy (The orchestration gateway) ---
  nginx:
    image: nginx:alpine
    container_name: gateway
    restart: unless-stopped
    ports:
      - "80:80"  # Only port 80 is exposed to the outside world
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - frontend
      - api
    networks:
      - app-network

  # --- Frontend ---
  frontend:
    build: 
      context: ./frontend
    container_name: frontend
    # ports:        <-- REMOVED (No direct access to port 8501)
    #   - "8501:8501" 
    environment:
      - API_URL=http://api:8000/generate # Internal Docker communication
    networks:
      - app-network

  # --- API ---
  api:
    build: 
      context: ./api
    container_name: api
    # ports:        <-- REMOVED (No direct access to port 8000)
    #   - "8000:8000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      init-permissions:
        condition: service_completed_successfully
    networks:
      - app-network

  # --- Init Container (Unchanged) ---
  init-permissions:
    image: busybox
    container_name: init-permissions
    command: sh -c "chmod 666 /var/run/docker.sock"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    user: root

networks:
  app-network:
    driver: bridge