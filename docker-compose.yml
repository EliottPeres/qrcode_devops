version: '3.8'

services:
  # 1. Frontend Service
  frontend:
    build: ./frontend
    ports:
      - "8501:8501"
    depends_on:
      - api
    environment:
      - API_URL=http://api:8000/generate

  # 2. Permission Initialization Service
  # This container runs as root, fixes socket permissions, then stops
  init-permissions:
    image: alpine
    # Command to grant permissions to everyone on the socket
    command: chmod 666 /var/run/docker.sock
    user: root
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  # 3. API Service
  api:
    build: ./api
    ports:
      - "8000:8000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      # API will wait for the permission fix to complete before starting
      init-permissions:
        condition: service_completed_successfully

  # 4. Worker Builder (unchanged)
  worker-builder:
    build: ./worker
    image: qrcode-worker:latest
    entrypoint: ["echo", "Worker image built successfully!"]

networks:
  default:
    driver: bridge